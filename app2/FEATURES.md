# ScoreKeeper 功能清单 v2.0

## 🎯 核心功能

### 1. 创建房间 ✅
- 设置房间名称（1-64字符）
- 选择最大人数（2-12人）
- 设置过期时间（默认120分钟）
- 创建者自动成为房主
- 自动进入房间并建立WebSocket连接

### 2. 邀请玩家 ✅
- **二维码分享**: 生成小程序二维码，扫码直接加入
- **房间ID**: 复制房间ID，好友手动输入加入
- **分享链接**: 微信分享小程序卡片，点击直接进入
- 支持多种场景：线下面对面、电话语音、微信群聊

### 3. 加入房间 ✅
- 扫描二维码加入
- 输入房间ID加入
- 点击分享链接加入
- 输入昵称（显示微信昵称名称）
- 自动建立WebSocket连接
- **实时通知**: 房间内所有人收到"XX加入了房间"提示 基于WebSocket

### 4. 玩家间计分 ✅
- 支持给任意玩家加分
- 预设分值：+1分、+5分、+10分
- 支持自定义分值（输入任意正整数）
- 批量给分支持（一次给多个人）
- 幂等性保证（防止重复计分）
- **实时通知**: 所有人收到"XX给XX加了N分"提示

### 5. 实时数据同步 ✅
- **计分板实时更新**: 无需手动刷新，自动显示最新分数 基于WebSocket
- **玩家列表实时更新**: 新玩家加入/离开自动更新 基于WebSocket
- **转移记录实时刷新**: 计分后自动显示最新记录 基于WebSocket
- **对局状态同步**: 开始/结束状态实时通知 基于WebSocket
- **WebSocket连接状态**: UI显示连接状态（🟢已连接/🔴未连接）

### 6. 房间管理 ✅
- **开始对局**: 房主专属，至少需要2名玩家
- **结束对局**: 房主专属，生成最终结算快照
- **邀请玩家**: 房主可以代替其他人加入
- **房间信息**: 显示ID、状态、人数、时间等

### 7. 统计与记录 ✅
- **计分板**: 实时显示所有玩家得分和排名 基于WebSocket
- **转移记录**: 详细记录每一笔给分（谁→谁，多少分，时间）
- **积分明细**: 查看个人收入/支出详情
- **结算快照**: 对局结束后保存最终排名和统计
- **历史记录**: 查看所有参与过的对局

---

## 🔥 WebSocket 实时功能

### 实时事件

| 事件 | 说明 | 触发时机 | 所有人可见 |
|------|------|----------|-----------|
| `player:joined` | 玩家加入 | 新玩家成功加入房间 | ✅ |
| `player:left` | 玩家离开 | 玩家主动离开或掉线 | ✅ |
| `transfer:created` | 给分记录 | 任意玩家给其他人加分 | ✅ |
| `scoreboard:update` | 计分板更新 | 分数变化时 | ✅ |
| `match:status` | 对局状态 | 开始/结束/过期 | ✅ |

### 连接保障

| 功能 | 说明 | 参数 |
|------|------|------|
| **长连接模式** | 纯WebSocket长连接 | 等待服务端推送 |
| **断线重连** | 自动重连机制 | 最多5次 |
| **指数退避** | 重连间隔递增 | 1s→2s→4s→8s→16s→30s |
| **状态恢复** | 重连后自动恢复 | 重新加入房间 |

### 实时通知示例

```
场景1: 玩家加入
"小明 加入了房间"

场景2: 计分操作  
"小张 给 小明 加了 10 分"

场景3: 玩家离开
"小明 离开了房间"

场景4: 对局状态
"对局状态: 进行中"

场景5: 重连成功
"✅ 已重新连接"
```

---

## 📱 用户界面

### 首页
- 创建房间（多人/单人模式）
- 扫码加入房间
- 查看未完成对局
- 查看历史数据
- 用户中心

### 房间页面
- **顶部**: 房间信息卡片（名称、ID、身份、连接状态）
- **操作栏**: 添加玩家、开始游戏、分享、刷新（房主专属）
- **玩家列表**: 头像、昵称、得分、加分按钮
- **底部**: 详细统计、结算房间
- **弹窗**: 分享房间（二维码、房间ID、分享链接）

### 积分统计页
- 全部记录
- 收入明细
- 支出明细
- 时间筛选
- 详细流水

### 个人中心
- 用户信息
- 历史对局
- 个人设置
- 关于应用

---

## 🎨 UI特色

### 赛博朋克风格
- 霓虹青绿主色调 (#22D3EE)
- 霓虹紫粉强调色 (#FF48F9)
- 发光阴影效果
- 半透明毛玻璃
- 渐变色彩
- 高对比度

### 交互动画
- 页面过渡动画
- 计分板更新动画
- 按钮点击反馈
- Toast提示动画

### 响应式设计
- 适配不同屏幕尺寸
- 自动布局调整
- 手势操作支持

---

## 🛡️ 安全与性能

### 并发安全
- **双锁机制**: 用户锁+Match锁
- **幂等性保证**: clientTxnId防重
- **分布式锁**: Redis实现
- **自动续期**: 防止死锁

### 数据一致性
- **事务保护**: 数据库事务
- **缓存同步**: Redis与DB同步
- **容错降级**: Redis故障不影响核心功能

### 性能优化
- **批量操作**: 减少数据库往返
- **N+1优化**: 避免循环查询
- **Redis Pipeline**: 批量执行命令
- **WebSocket推送**: 减少轮询

### 资源限制
- 最大人数: 12人
- 过期时间: 最长30天
- 批量记分: 最多100条
- 锁超时: 5-10秒
- 缓存TTL: 6小时

---

## 🎮 支持的计分场景

### 麻将计分 🀄
- 4人局
- 回合管理
- 番型计算
- 胡牌记录

### 狼人杀 🐺
- 6-18人
- 角色管理
- 多轮投票
- 阵营对抗

### 桌游计分 🎲
- 多种规则
- 灵活计分
- 资源管理
- 撤销操作

### 德州扑克 ♠️
- 筹码管理
- 买入提现
- 资金流水
- 多人同时

---

## 📊 技术指标

### 性能指标
- WebSocket连接: <100ms延迟
- 计分操作: <200ms响应
- 页面加载: <1s
- 断线重连: <5s

### 可用性指标
- 连接成功率: >99%
- 重连成功率: >95%
- API成功率: >99.9%
- 数据准确率: 100%

---

## 🚀 未来规划

### v2.5.0 - 增强体验
- 语音提示
- 动画效果
- 房间设置
- 静音模式

### v2.6.0 - 社交功能
- 好友系统
- 常玩玩家
- 快速邀请
- 游戏模板

---
